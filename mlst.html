<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MLST í•™ìŠµ ì„±ê²© ìœ í˜• ì§„ë‹¨ - ë§¥ì—ë“€í…Œí¬</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f1f5f9; --card:#ffffff; --primary:#1e40af; --secondary:#3b82f6;
      --text:#1e293b; --border:#e2e8f0; --muted:#64748b;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    body{
      font-family:'Pretendard',sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:20px;
      line-height:1.6;
    }
    .container{max-width:980px;margin:0 auto;}
    .card{
      background:var(--card);
      border-radius:20px;
      padding:30px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);
      margin-bottom:25px;
    }
    h1{text-align:center;color:var(--primary);font-weight:800;margin:0 0 10px;}
    .instruction{
      background:#eff6ff;
      padding:15px;
      border-radius:12px;
      font-size:0.92rem;
      margin-bottom:25px;
      border-left:5px solid var(--secondary);
    }

    /* ë¬¸í•­ */
    .q-row{
      border-bottom:1px solid var(--border);
      padding:18px 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
    }
    .q-text{font-weight:600;flex:1;padding-right:10px;}
    .options{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .opt-label{font-size:0.8rem;text-align:center;cursor:pointer;min-width:34px;}
    input[type="radio"]{display:block;margin:5px auto;}

    .btn-group{display:flex;gap:12px;margin-top:22px;flex-wrap:wrap;}
    button{
      flex:1;
      min-width:220px;
      padding:16px 14px;
      border-radius:12px;
      border:none;
      font-weight:800;
      cursor:pointer;
      transition:0.25s;
      font-size:1rem;
    }
    .btn-main{background:var(--primary);color:#fff;}
    .btn-sub{background:#0f172a;color:#fff;}
    .btn-save{background:#64748b;color:#fff;}
    .btn-ghost{background:transparent;color:#64748b;border:1px solid #cbd5e1;}

    /* ê²°ê³¼ */
    #resultArea{display:none;}

    /* ê·¸ë˜í”„ */
    .chart-container{
      display:flex;
      justify-content:center;
      align-items:center;
      margin:8px 0 10px;
    }
    .chart-box{
      width:360px;
      height:390px;
    }

    .analysis-box{
      background:#f8fafc;
      padding:20px;
      border-radius:16px;
      border:1px solid var(--border);
    }
    .type-badge{
      display:inline-block;
      padding:4px 12px;
      border-radius:999px;
      background:var(--primary);
      color:#fff;
      font-size:0.85rem;
      margin-bottom:10px;
      font-weight:800;
    }

    .summary-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    @media (max-width:768px){ .summary-row{ grid-template-columns:1fr; } }

    .pill{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .pill small{color:var(--muted);display:block;margin-top:2px;}
    .score{font-weight:900;}
    .tag{
      font-size:0.75rem;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:#f8fafc;
      display:inline-block;
      margin-top:6px;
      text-align:center;
      min-width:64px;
      font-weight:800;
    }
    .tag.good{color:var(--good);border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.08);}
    .tag.warn{color:var(--warn);border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.08);}
    .tag.bad{color:var(--bad);border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);}

    .section-title{margin:18px 0 8px;font-weight:900;color:#0f172a;}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:768px){.cards{grid-template-columns:1fr;}}

    .mini-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .mini-card h4{margin:0 0 6px;font-size:1rem;}
    .mini-card p{margin:0;color:#334155;font-size:.92rem;}
    .mini-card ul{margin:8px 0 0;padding-left:18px;color:#334155;font-size:.9rem;}
    .hr{margin:16px 0;border:0;border-top:1px solid var(--border);}

    .footer-note{
      text-align:center;
      font-size:0.8rem;
      color:#94a3b8;
      margin-top:22px;
    }

    .policy-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:768px){ .policy-grid{ grid-template-columns:1fr; } }

    .kpi{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
    .kpi b{font-weight:900;}
    .kpi small{color:var(--muted);display:block;margin-top:2px;}
  </style>
</head>

<body>
<div class="container">

  <!-- í…ŒìŠ¤íŠ¸ ì˜ì—­ -->
  <div class="card" id="testCard">
    <h1>ğŸ§  MLST í•™ìŠµ ì„±ê²© ìœ í˜• ì§„ë‹¨</h1>
    <div class="instruction">
      ê° ë¬¸í•­ì„ ì½ê³  ìì‹ ì—ê²Œ ê°€ì¥ ê°€ê¹Œìš´ ì •ë„ë¥¼ ì²´í¬í•´ ì£¼ì„¸ìš”.<br>
      (1: ì „í˜€ ì•„ë‹ˆë‹¤ / 2: ì•„ë‹ˆë‹¤ / 3: ë³´í†µì´ë‹¤ / 4: ê·¸ë ‡ë‹¤ / 5: ë§¤ìš° ê·¸ë ‡ë‹¤)<br><br>
      â€» ì£¼ì˜: â€˜ë¶ˆì•ˆí•˜ë‹¤/ííŠ¸ëŸ¬ì§„ë‹¤â€™ì²˜ëŸ¼ <b>ë¬¸í•­ì´ ë¶€ì •í˜•</b>ì¸ ê²½ìš°, ê²°ê³¼ ì ìˆ˜ëŠ” <b>ì—­ì±„ì (5â†’1)</b>ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.
    </div>

    <form id="mlstForm">
      <div id="questions"></div>
      <div class="btn-group">
        <button type="button" class="btn-main" onclick="processMLST()">ì§„ë‹¨ ê²°ê³¼ ìƒì„±</button>
      </div>
    </form>
  </div>

  <!-- ê²°ê³¼ ì˜ì—­ -->
  <div id="resultArea">
    <div class="card" id="captureArea">
      <h2 style="text-align:center;color:var(--primary);margin:0 0 12px;">ğŸ” í•™ìŠµ ì„±ê²© ìœ í˜• ë¶„ì„ ë¦¬í¬íŠ¸</h2>

      <div class="chart-container">
        <div class="chart-box">
          <canvas id="mlstChart"></canvas>
        </div>
      </div>
      <p style="text-align:center;font-size:0.9rem;color:var(--muted);margin:0 0 18px;">
        â€» 100ì  í™˜ì‚° ê¸°ì¤€ í•™ìŠµ ë°¸ëŸ°ìŠ¤
      </p>

      <div class="analysis-box">
        <div id="typeResult"></div>

        <div class="summary-row" id="scoreSummary"></div>

        <div class="hr"></div>

        <div id="strengthWeakness"></div>

        <div class="section-title">ìŠ¤ì¼€ì¤„ëŸ¬ ë°˜ì˜ ì¶”ì²œ(ìë™ ì„¤ì •ê°’)</div>
        <div id="schedulerPolicy"></div>

        <!-- âœ… NEW: ê³¼ëª©ë³„ GPT í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸° -->
        <div class="section-title">ê³¼ëª©ë³„ GPT í•™ìŠµ ì½”ì¹˜ í”„ë¡¬í”„íŠ¸</div>
        <div class="mini-card">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <b>ê³¼ëª© ì„ íƒ</b>
            <select id="subjectSelect" style="padding:6px 10px;border-radius:8px;border:1px solid #cbd5e1;">
              <option value="êµ­ì–´">êµ­ì–´</option>
              <option value="ìˆ˜í•™">ìˆ˜í•™</option>
              <option value="ì˜ì–´">ì˜ì–´</option>
              <option value="íƒêµ¬">íƒêµ¬</option>
            </select>

            <button class="btn-main" style="flex:0;min-width:160px;" type="button" onclick="generatePrompt()">í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
            <button class="btn-sub" style="flex:0;min-width:120px;" type="button" onclick="copyPrompt()">ë³µì‚¬</button>
          </div>

          <textarea id="promptBox" rows="10"
            style="width:100%;margin-top:12px;border-radius:10px;padding:12px;border:1px solid #cbd5e1;font-size:.9rem;"></textarea>

          <div style="margin-top:8px;color:var(--muted);font-size:.86rem;">
            * ë²„íŠ¼ í´ë¦­ í›„ ìƒì„±ëœ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ChatGPTì— ë¶™ì—¬ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="section-title">ì˜ì—­ë³„ ìƒì„¸ ë¶„ì„</div>
        <div class="cards" id="detailCards"></div>

        <div class="section-title">ì‹¤í–‰ í”Œëœ</div>
        <div id="actionPlan"></div>
      </div>

      <p class="footer-note">
        ë³¸ ì§„ë‹¨ì€ ê³ 1 í•™ìŠµ ì»¨ì„¤íŒ… 'í•™ìŠµ ì§„ë‹¨ ë° ëª©í‘œ ì„¤ì •' ë‹¨ê³„ì˜ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.
      </p>
    </div>

    <div class="btn-group">
      <button class="btn-save" onclick="downloadResult()">ê²°ê³¼ì§€ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>

      <button class="btn-sub" type="button" onclick="applyToScheduler()">
        ìŠ¤ì¼€ì¤„ëŸ¬ì— ë°˜ì˜í•˜ê¸°
      </button>

      <button class="btn-ghost" type="button" onclick="location.reload()">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</button>
    </div>
  </div>

</div>

<script>
  /***********************
   * 1) ë¬¸í•­ (âœ… reverse í”Œë˜ê·¸ ì¶”ê°€)
   *    - ë¶ˆì•ˆ/ì§‘ì¤‘ ë¬¸í•­ì€ "ë™ì˜í• ìˆ˜ë¡ ë‚˜ìœ ìƒíƒœ"ë¼ ì—­ì±„ì  í•„ìš”
   ***********************/
  const questions = [
    { q: "ë‚˜ëŠ” ì–´ë ¤ìš´ ë¬¸ì œë¥¼ ëê¹Œì§€ í’€ì–´ëƒˆì„ ë•Œ í° ê¸°ì¨ì„ ëŠë‚€ë‹¤.", cat: "motivation", reverse:false },
    { q: "ë‚˜ëŠ” êµ¬ì²´ì ì¸ í•™ìŠµ ëª©í‘œë¥¼ ì„¸ìš°ê³  ê³µë¶€ë¥¼ ì‹œì‘í•œë‹¤.", cat: "motivation", reverse:false },
    { q: "ì‹œí—˜ ê¸°ê°„ì´ ë‹¤ê°€ì˜¤ë©´ ì§€ë‚˜ì¹˜ê²Œ ê¸´ì¥ë˜ê³  ë¶ˆì•ˆí•˜ë‹¤.", cat: "anxiety", reverse:true },           // âœ… ì—­ì±„ì (ì‹¬ë¦¬ì•ˆì •)
    { q: "ê³µë¶€í•  ë•Œ ì‘ì€ ì†ŒìŒì—ë„ ì‰½ê²Œ ì§‘ì¤‘ë ¥ì´ ííŠ¸ëŸ¬ì§„ë‹¤.", cat: "concentration", reverse:true },      // âœ… ì—­ì±„ì (ë²„ê·¸ ìˆ˜ì •)
    { q: "ê³µë¶€í•œ ë‚´ìš©ì„ ë‚˜ë§Œì˜ ë°©ì‹ìœ¼ë¡œ ì •ë¦¬í•˜ì—¬ ìš”ì•½í•œë‹¤.", cat: "skill", reverse:false },
    { q: "ëª¨ë¥´ëŠ” ë‚´ìš©ì´ ë‚˜ì˜¤ë©´ ì´í•´ë  ë•Œê¹Œì§€ ì§ˆë¬¸í•˜ê±°ë‚˜ ì°¾ì•„ë³¸ë‹¤.", cat: "will", reverse:false },
    { q: "ë‚˜ëŠ” ë‚´ê°€ ë¬´ì—‡ì„ ì•Œê³  ë¬´ì—‡ì„ ëª¨ë¥´ëŠ”ì§€ ì •í™•íˆ ì•Œê³  ìˆë‹¤.", cat: "metacognition", reverse:false }
  ];

  // ë¬¸í•­ ë Œë”ë§
  const qContainer = document.getElementById('questions');
  questions.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'q-row';
    div.innerHTML = `
      <div class="q-text">${idx + 1}. ${item.q}</div>
      <div class="options">
        ${[1,2,3,4,5].map(v => `
          <label class="opt-label">${v}
            <input type="radio" name="q${idx}" value="${v}" required>
          </label>
        `).join('')}
      </div>
    `;
    qContainer.appendChild(div);
  });

  /***********************
   * 2) ì ìˆ˜ ê³„ì‚° & ê²°ê³¼ ë Œë”
   ***********************/
  let mlstChart = null;
  let g_lastScores = null;

  function processMLST(){
    const form = document.getElementById('mlstForm');
    const formData = new FormData(form);

    let scores = { motivation:0, anxiety:0, concentration:0, skill:0, will:0, metacognition:0 };
    let allAnswered = true;

    questions.forEach((item, idx) => {
      const val = formData.get(`q${idx}`);
      if(!val) allAnswered = false;
      else{
        const raw = parseInt(val, 10);
        const finalVal = item.reverse ? (6 - raw) : raw;    // âœ… reverse ë°˜ì˜
        scores[item.cat] += (finalVal * 20);                // 100ì  í™˜ì‚°
      }
    });

    if(!allAnswered){ alert("ëª¨ë“  ë¬¸í•­ì— ë‹µë³€í•´ ì£¼ì„¸ìš”."); return; }

    g_lastScores = scores;
    persistMLST(scores);

    document.getElementById('testCard').style.display = 'none';
    document.getElementById('resultArea').style.display = 'block';

    renderChart(Object.values(scores));
    renderAnalysis(scores);
    renderSchedulerPolicy(scores);

    // âœ… NEW: ê²°ê³¼ ëœ¨ìë§ˆì ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ 1íšŒ ìë™ ìƒì„±(ì„ íƒ)
    generatePrompt();
  }

  function persistMLST(scores){
    localStorage.setItem("mlst_profile_v1", JSON.stringify({
      version: 1,
      createdAt: Date.now(),
      scores
    }));
  }

  function applyToScheduler(){
    const raw = localStorage.getItem("mlst_profile_v1");
    if(!raw){
      alert("ë¨¼ì € ì§„ë‹¨ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.");
      return;
    }
    location.href = "scheduler.html?from=mlst";
  }

  /***********************
   * 3) ì°¨íŠ¸
   ***********************/
  function renderChart(data){
    const ctx = document.getElementById('mlstChart').getContext('2d');
    if(mlstChart) mlstChart.destroy();

    mlstChart = new Chart(ctx, {
      type:'radar',
      data:{
        labels:['í•™ìŠµë™ê¸°','ì‹¬ë¦¬ì•ˆì •','ì§‘ì¤‘ë ¥','ê³µë¶€ê¸°ìˆ ','í•™ìŠµì˜ì§€','ë©”íƒ€ì¸ì§€'],
        datasets:[{
          data,
          backgroundColor:'rgba(30, 64, 175, 0.2)',
          borderColor:'rgba(30, 64, 175, 1)',
          borderWidth:2,
          pointBackgroundColor:'rgba(30, 64, 175, 1)'
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ top:30, right:20, bottom:20, left:20 } },
        scales:{
          r:{
            beginAtZero:true,
            max:100,
            ticks:{ display:false },
            pointLabels:{ padding:12, font:{ size:13 } }
          }
        },
        plugins:{ legend:{ display:false } }
      }
    });
  }

  /***********************
   * 4) ìƒì„¸ ê²°ê³¼ ë¡œì§
   ***********************/
  const LABELS = {
    motivation: "í•™ìŠµë™ê¸°",
    anxiety: "ì‹¬ë¦¬ì•ˆì •",
    concentration: "ì§‘ì¤‘ë ¥",
    skill: "ê³µë¶€ê¸°ìˆ ",
    will: "í•™ìŠµì˜ì§€",
    metacognition: "ë©”íƒ€ì¸ì§€"
  };

  function levelTag(score){
    if(score >= 85) return { text:"ë§¤ìš° ë†’ìŒ", cls:"good" };
    if(score >= 70) return { text:"ë†’ìŒ", cls:"good" };
    if(score >= 55) return { text:"ë³´í†µ", cls:"warn" };
    if(score >= 40) return { text:"ë‚®ìŒ", cls:"bad" };
    return { text:"ë§¤ìš° ë‚®ìŒ", cls:"bad" };
  }

  function oneLineDiagnosis(key, score){
    const L = levelTag(score).text;
    const map = {
      motivation: {
        hi: "ëª©í‘œê°€ ìƒê¸°ë©´ ìŠ¤ìŠ¤ë¡œ ì¶”ì§„ë ¥ì´ ë¶™ëŠ” íƒ€ì…",
        mid: "ìê·¹ì´ ìˆìœ¼ë©´ ì˜¬ë¼ê°€ì§€ë§Œ ìœ ì§€ê°€ ê´€ê±´",
        low: "ê³µë¶€ê°€ â€˜í•´ì•¼ í•  ì¼â€™ë¡œë§Œ ëŠê»´ì§ˆ ê°€ëŠ¥ì„±"
      },
      anxiety: {
        hi: "ì‹œí—˜ ìƒí™©ì—ì„œë„ ë¹„êµì  ì•ˆì •ì ìœ¼ë¡œ ë²„íŒ€",
        mid: "ë¶ˆì•ˆì´ ì„±ì ì— ì˜í–¥ì„ ì¤„ ë•Œê°€ ìˆìŒ",
        low: "ë¶ˆì•ˆ/ì••ë°•ì´ í•™ìŠµ íš¨ìœ¨ì„ í¬ê²Œ ë–¨ì–´ëœ¨ë¦´ ìˆ˜ ìˆìŒ"
      },
      concentration: {
        hi: "í™˜ê²½ ë³€í™”ì—ë„ ì§‘ì¤‘ì„ ìœ ì§€í•˜ëŠ” í¸",
        mid: "ì»¨ë””ì…˜/í™˜ê²½ì— ë”°ë¼ í”ë“¤ë¦´ ìˆ˜ ìˆìŒ",
        low: "ì‚°ë§Œí•¨ì´ ëˆ„ì ë˜ì–´ ì‹œê°„ ëŒ€ë¹„ ì„±ê³¼ê°€ ë‚®ì•„ì§ˆ ìˆ˜ ìˆìŒ"
      },
      skill: {
        hi: "ì •ë¦¬Â·ë³µìŠµÂ·ë¬¸ì œí’€ì´ ë£¨í‹´ì´ ì˜ ì¡í˜",
        mid: "ë°©ë²•ì€ ìˆìœ¼ë‚˜ ì¼ê´€ì„±/ì •êµí™”ê°€ í•„ìš”",
        low: "ë…¸ë ¥ ëŒ€ë¹„ ì ìˆ˜ë¡œ ì—°ê²°ì´ ëœ ë˜ëŠ” êµ¬ê°„"
      },
      will: {
        hi: "ë§‰íŒ ë²„í‹°ê¸°ì™€ ë£¨í‹´ ìœ ì§€ê°€ ê°•ì ",
        mid: "ê³„íšì€ ì„¸ìš°ì§€ë§Œ ëŠê¸°ëŠ” êµ¬ê°„ì´ ìƒê¸¸ ìˆ˜ ìˆìŒ",
        low: "ì‘ì€ ì‹¤íŒ¨ê°€ â€˜í¬ê¸°â€™ë¡œ ì´ì–´ì§€ê¸° ì‰¬ì›€"
      },
      metacognition: {
        hi: "ìê¸° ì•½ì ì„ ì •í™•íˆ ì°ê³  ë³´ì™„í•˜ëŠ” í¸",
        mid: "ëŒ€ëµì€ ì•Œì§€ë§Œ ì˜¤ë‹µ ì›ì¸ ë¶„í•´ê°€ ë” í•„ìš”",
        low: "â€˜ì•ˆë‹¤/ëª¨ë¥¸ë‹¤â€™ êµ¬ë¶„ì´ íë ¤ ë¹„íš¨ìœ¨ì´ ìƒê¸¸ ìˆ˜ ìˆìŒ"
      }
    };
    if(score >= 70) return `${L} Â· ${map[key].hi}`;
    if(score >= 55) return `${L} Â· ${map[key].mid}`;
    return `${L} Â· ${map[key].low}`;
  }

  function prescriptions(key, score){
    const P = {
      motivation: {
        symptom: "ì‹œì‘ì€ í•˜ëŠ”ë° ê¸ˆë°© íì§€ë¶€ì§€ / ëª©í‘œê°€ â€˜ì¶”ìƒì â€™",
        cause: "ëª©í‘œê°€ ì ìˆ˜Â·ë“±ê¸‰ë§Œ ë‚¨ê³  â€˜í–‰ë™â€™ìœ¼ë¡œ ë²ˆì—­ì´ ì•ˆ ë¨",
        do: [
          "ì´ë²ˆ ì£¼ ëª©í‘œë¥¼ â€˜í–‰ë™â€™ìœ¼ë¡œ 3ê°œë§Œ: (ì˜ˆ) ìˆ˜í•™ 4ì  20ë¬¸í•­, ì˜ì–´ ë¹ˆì¹¸ 15ì§€ë¬¸",
          "í•˜ë£¨ ì‹œì‘ 5ë¶„: ì˜¤ëŠ˜ í•  ì¼ 2ì¤„ + ëë‚˜ë©´ ì²´í¬",
          "ë³´ìƒì€ â€˜ì‹œê°„â€™ì´ ì•„ë‹ˆë¼ â€˜ì™„ë£Œâ€™ì— ê±¸ê¸°"
        ]
      },
      anxiety: {
        symptom: "ì‹œí—˜/ë°œí‘œ/ì±„ì  ë•Œ ì‹¬ì¥ì´ ë¹¨ë¼ì§€ê³  ë¨¸ë¦¬ê°€ í•˜ì–˜ì§",
        cause: "í†µì œ ë¶ˆê°€ëŠ¥ ìš”ì†Œ(ê²°ê³¼)ì— ì´ˆì  â†’ ê³¼ê°ì„±",
        do: [
          "ê³µë¶€ ì‹œì‘ ì „ 60ì´ˆ í˜¸í¡(4ì´ˆ ë“¤ìˆ¨-4ì´ˆ ë©ˆì¶¤-6ì´ˆ ë‚ ìˆ¨)",
          "ëª©í‘œë¥¼ â€˜ì ìˆ˜â€™ ëŒ€ì‹  â€˜ê³¼ì •â€™ìœ¼ë¡œ ìª¼ê°œê¸°(ì˜¤ëŠ˜ì€ ì˜¤ë‹µ 10ê°œë§Œ)",
          "ì‹œí—˜ ì „ë‚ : ìƒˆ ë¬¸ì œ ê¸ˆì§€, ì˜¤ë‹µÂ·ìš”ì•½ë§Œ"
        ]
      },
      concentration: {
        symptom: "í°/ì¡ìƒê°/ì†ŒìŒì— ìì£¼ ëŠê¹€",
        cause: "ì§‘ì¤‘ ìŠ¤ìœ„ì¹˜ê°€ â€˜í™˜ê²½â€™ì— ì˜ì¡´",
        do: [
          "25-5(ë˜ëŠ” 40-10) íƒ€ì´ë¨¸ë¡œ â€˜ëŠê¹€â€™ ìì²´ë¥¼ ì„¤ê³„",
          "í°ì€ ë‹¤ë¥¸ ë°©/ê°€ë°© ê¹Šìˆ™ì´(ì‹œì•¼ì—ì„œ ì œê±°ê°€ í•µì‹¬)",
          "ì§‘ì¤‘ì´ ê¹¨ì§€ë©´ â€˜í•  ì¼ 1ì¤„â€™ë§Œ ë‹¤ì‹œ ì ê³  ì¬ì‹œì‘"
        ]
      },
      skill: {
        symptom: "ë§ì´ í–ˆëŠ”ë° ì„±ì ì´ ëœ ì˜¤ë¦„ / ë³µìŠµì´ ìŒ“ì„",
        cause: "ì¸í’‹(ì½ê¸°) ì¤‘ì‹¬ â†’ ì•„ì›ƒí’‹(ì¸ì¶œ) ë¶€ì¡±",
        do: [
          "ê³µë¶€ì˜ 50%ëŠ” â€˜ë¬¸ì œ/í€´ì¦ˆ/ë°±ì§€ë³µìŠµâ€™ë¡œ",
          "ì˜¤ë‹µì€ 1) ì™œ í‹€ë¦¼ 2) ë‹¤ìŒì—” ì–´ë–»ê²Œ 3) ìœ ì‚¬ë¬¸í•­ 1ê°œ",
          "ìš”ì•½ì€ â€˜í•œ ì¥â€™ì´ ì•„ë‹ˆë¼ â€˜ì„¸ ì¤„â€™ë¡œ ì••ì¶•"
        ]
      },
      will: {
        symptom: "ì‘ì€ ì‹¤íŒ¨ ë’¤ ë£¨í‹´ì´ ë¬´ë„ˆì§",
        cause: "ê³„íšì´ â€˜ì™„ë²½â€™ ê¸°ì¤€ì´ë¼ í”ë“¤ë¦¬ë©´ ì „ë¶€ í¬ê¸°",
        do: [
          "ìµœì†Œê¸°ì¤€(ë°”ë‹¥ë£¨í‹´) ì„¤ì •: ë§¤ì¼ 30ë¶„ì€ ë¬´ì¡°ê±´",
          "ì£¼ 1íšŒ â€˜ë¦¬ì…‹ ë°ì´â€™: ë°€ë¦° ê²ƒ ì •ë¦¬ + ê³„íš ì¬ì„¤ì •",
          "í˜ë“  ë‚ ì—” â€˜ë‚œì´ë„â€™ ëŒ€ì‹  â€˜ë¶„ëŸ‰â€™ë§Œ ì¤„ì´ê¸°"
        ]
      },
      metacognition: {
        symptom: "ë­˜ë¶€í„° í•´ì•¼ í• ì§€ ëª¨ë¥´ê² ê³ , ì•½ì ì´ ê³„ì† ë°˜ë³µ",
        cause: "ì˜¤ë‹µ ì›ì¸ ë¶„ë¥˜ê°€ ì—†ìŒ(ê°œë…/ê³„ì‚°/ë…í•´/ì‹œê°„ ë“±)",
        do: [
          "ì˜¤ë‹µ íƒœê·¸ 4ê°œë§Œ: ê°œë…Â·ê³„ì‚°Â·ì‹¤ìˆ˜Â·ì‹œê°„(ë˜ëŠ” ë…í•´)",
          "íƒœê·¸ë³„ë¡œ â€˜ì²˜ë°©â€™ ê³ ì •: ê³„ì‚°=ìœ í˜• 10ê°œ, ì‹œê°„=ì œí•œì‹œê°„ í›ˆë ¨",
          "ë§¤ì£¼ 1íšŒ: íƒœê·¸ ë¹„ìœ¨ ë³´ê³  ë‹¤ìŒ ì£¼ ê³„íš ì¡°ì •"
        ]
      }
    };

    const base = P[key];
    if(score >= 80){
      return {
        symptom: "ì´ ì˜ì—­ì€ ì´ë¯¸ ìƒìœ„ê¶Œ ë£¨í‹´ì´ ì¡í˜€ ìˆìŒ",
        cause: "ìœ ì§€í•˜ë©´ì„œ â€˜ê³ ë‚œë„/ì‹¤ì „â€™ìœ¼ë¡œ í™•ì¥í•˜ë©´ ë¨",
        do: [
          "ì‹¤ì „ ì¡°ê±´(ì‹œê°„/í™˜ê²½)ì—ì„œ 1íšŒ ë” ë°˜ë³µ",
          "ë‚´ ì•½ì  íƒœê·¸ 1ê°œë¥¼ ì •í•´ â€˜ì£¼ 2íšŒâ€™ë§Œ ì§‘ì¤‘ ê°•í™”",
          "ë‹¤ë¥¸ ì˜ì—­(ë‚®ì€ ì ìˆ˜)ì„ ëŒì–´ì˜¬ë¦¬ëŠ” â€˜ë²„íŒ€ëª©â€™ìœ¼ë¡œ í™œìš©"
        ]
      };
    }
    return base;
  }

  function typeAndAdvice(scores){
    const entries = Object.entries(scores).map(([k,v]) => ({k, v}));
    entries.sort((a,b) => b.v - a.v);
    const top = entries.slice(0,2);
    const low = entries.slice(-2);

    const highAvg = (top[0].v + top[1].v)/2;
    const lowAvg = (low[0].v + low[1].v)/2;

    let type = "ì„±ì¥ ì ì¬ë ¥í˜•";
    let advice = "ê¸°ë³¸ ë£¨í‹´ë§Œ ì¡ì•„ë„ ì„±ì  ìƒìŠ¹ì´ ê°€ëŠ¥í•œ êµ¬ê°„ì…ë‹ˆë‹¤. ë‚®ì€ 2ê°œ ì˜ì—­ì„ ë¨¼ì € ëŒì–´ì˜¬ë¦¬ì„¸ìš”.";

    if(highAvg >= 85 && lowAvg >= 70){
      type = "ë°¸ëŸ°ìŠ¤ ìƒìœ„ê¶Œí˜•";
      advice = "í•™ìŠµ ë°¸ëŸ°ìŠ¤ê°€ ì•ˆì •ì ì…ë‹ˆë‹¤. ì‹¤ì „ íƒ€ì„ì–´íƒÂ·ê³ ë‚œë„ ë¹„ì¤‘ì„ ëŠ˜ë¦¬ë©´ ì„±ì ì´ í•œ ë‹¨ê³„ ì˜¬ë¼ê°‘ë‹ˆë‹¤.";
    } else if(scores.metacognition >= 80 && scores.will >= 80){
      type = "ìê¸°ì£¼ë„ ì™„ì„±í˜•";
      advice = "ìê¸°ì ê²€ê³¼ ë£¨í‹´ ìœ ì§€ê°€ ê°•ì ì…ë‹ˆë‹¤. ì•½ì  íƒœê·¸ 1ê°œë§Œ ì •ë°€ íƒ€ê²©í•˜ë©´ ìƒìœ„ê¶Œì´ êµ³ì–´ì§‘ë‹ˆë‹¤.";
    } else if(scores.motivation >= 80 && scores.skill < 60){
      type = "ì—´ì • ê³¼ë‹¤ ë…¸ì˜¤ë ¥í˜•";
      advice = "ì˜ìš•ì€ ì¶©ë¶„í•œë° ì ìˆ˜ë¡œ ì—°ê²°ë˜ëŠ” ê¸°ìˆ ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. â€˜ì¸ì¶œí•™ìŠµ+ì˜¤ë‹µ ë¶„í•´â€™ë¡œ íš¨ìœ¨ì„ ë°”ê¾¸ì„¸ìš”.";
    } else if(scores.anxiety <= 40){
      type = "ì‹¬ë¦¬ ë¶ˆì•ˆ ìœ„í—˜í˜•";
      advice = "ë¶ˆì•ˆì´ í•™ìŠµì„ ëŠê³  ìˆìŠµë‹ˆë‹¤. ê³„íšì„ ìª¼ê°œê³ (ê³¼ì • ëª©í‘œ), í˜¸í¡Â·ë£¨í‹´ìœ¼ë¡œ ì•ˆì •ë„ë¥¼ ë¨¼ì € ì˜¬ë ¤ì•¼ í•©ë‹ˆë‹¤.";
    } else if(scores.concentration <= 40){
      type = "ì§‘ì¤‘ ë¶„ì‚° ìœ„í—˜í˜•";
      advice = "ì§‘ì¤‘ì´ ìƒˆëŠ” êµ¬ê°„ì´ í½ë‹ˆë‹¤. íƒ€ì´ë¨¸/í™˜ê²½ ì œê±°ë¡œ â€˜ëŠê¹€ì„ ì¤„ì´ëŠ” ì„¤ê³„â€™ê°€ ìµœìš°ì„ ì…ë‹ˆë‹¤.";
    }

    return { type, advice, top, low };
  }

  function renderAnalysis(scores){
    const typeBox = document.getElementById('typeResult');
    const scoreSummary = document.getElementById('scoreSummary');
    const swBox = document.getElementById('strengthWeakness');
    const cardsBox = document.getElementById('detailCards');
    const planBox = document.getElementById('actionPlan');

    const { type, advice, top, low } = typeAndAdvice(scores);

    typeBox.innerHTML = `
      <span class="type-badge">ìœ í˜• ì§„ë‹¨</span>
      <h3 style="margin:0;">${type}</h3>
      <p style="margin:8px 0 0;color:#334155;"><b>ğŸ’¡ ì»¨ì„¤í„´íŠ¸ ì´í‰:</b> ${advice}</p>
      <p style="margin:8px 0 0;font-size:.85rem;color:var(--muted);">
        * â€˜ì‹¬ë¦¬ì•ˆì •â€™ì€ ë¶ˆì•ˆ ë¬¸í•­ì„ ì—­ì±„ì (ë¶ˆì•ˆ ë†’ì„ìˆ˜ë¡ ì ìˆ˜ ë‚®ìŒ)ìœ¼ë¡œ í™˜ì‚°í•©ë‹ˆë‹¤.
      </p>
    `;

    const order = ["motivation","anxiety","concentration","skill","will","metacognition"];
    scoreSummary.innerHTML = order.map(k => {
      const s = scores[k];
      const tag = levelTag(s);
      return `
        <div class="pill">
          <div>
            <div style="font-weight:900;">${LABELS[k]}</div>
            <small>${oneLineDiagnosis(k, s)}</small>
          </div>
          <div style="text-align:right;">
            <div class="score">${s}</div>
            <div class="tag ${tag.cls}">${tag.text}</div>
          </div>
        </div>
      `;
    }).join("");

    const topText = top.map(x => `${LABELS[x.k]}(${x.v})`).join(", ");
    const lowText = low.map(x => `${LABELS[x.k]}(${x.v})`).join(", ");
    swBox.innerHTML = `
      <div class="section-title">í•µì‹¬ ìš”ì•½</div>
      <div class="mini-card">
        <p style="margin:0;"><b>âœ… ê°•ì  TOP2</b>: ${topText}</p>
        <p style="margin:6px 0 0;"><b>âš ï¸ ë³´ì™„ TOP2</b>: ${lowText}</p>
      </div>
    `;

    cardsBox.innerHTML = order.map(k => {
      const s = scores[k];
      const tag = levelTag(s);
      const pr = prescriptions(k, s);
      return `
        <div class="mini-card">
          <h4>
            ${LABELS[k]} <span class="tag ${tag.cls}">${tag.text}</span>
            <span style="float:right;font-weight:900;">${s}ì </span>
          </h4>
          <p><b>í•œì¤„ ì§„ë‹¨:</b> ${oneLineDiagnosis(k, s)}</p>
          <ul>
            <li><b>ì§•í›„</b>: ${pr.symptom}</li>
            <li><b>ì›ì¸</b>: ${pr.cause}</li>
            <li><b>ì²˜ë°©(ë°”ë¡œ ì‹¤í–‰)</b>:
              <div style="margin-top:6px;">
                ${pr.do.map(x => `<div>â€¢ ${x}</div>`).join("")}
              </div>
            </li>
          </ul>
        </div>
      `;
    }).join("");

    const lowKeys = low.map(x => x.k);
    planBox.innerHTML = `
      <div class="mini-card">
        <p style="margin:0;"><b>ì˜¤ëŠ˜(ë°”ë¡œ ì ìš©)</b></p>
        <ul>
          <li>${LABELS[lowKeys[0]]}: ì²˜ë°© 1ê°œë§Œ ì„ íƒí•´ì„œ 20ë¶„ ì‹¤í–‰</li>
          <li>${LABELS[lowKeys[1]]}: í™˜ê²½/ë£¨í‹´ 1ê°œë§Œ â€˜ê³ ì •â€™</li>
        </ul>
        <p style="margin:10px 0 0;"><b>ì´ë²ˆ ì£¼</b></p>
        <ul>
          <li>ë‚®ì€ ì˜ì—­ 2ê°œë¥¼ ì£¼ 4íšŒì”©(ì§§ì•„ë„ OK) ë°˜ë³µ</li>
          <li>ì˜¤ë‹µ/ê¸°ë¡ì„ ë‚¨ê²¨ ë‹¤ìŒ ì£¼ ê³„íšì„ â€˜ë°ì´í„°ë¡œâ€™ ìˆ˜ì •</li>
        </ul>
        <p style="margin:10px 0 0;"><b>ì‹œí—˜ 2ì£¼ ì „</b></p>
        <ul>
          <li>ì‹¤ì „ ëª¨ë“œ(ì‹œê°„ ì œí•œ)ë¡œ ì£¼ 2íšŒ ì „í™˜</li>
          <li>ë¶ˆì•ˆ/ì§‘ì¤‘ì´ í”ë“¤ë¦¬ë©´ â€˜ê³¼ì • ëª©í‘œâ€™ë¡œ ë‹¤ì‹œ ìª¼ê°œì„œ ìœ ì§€</li>
        </ul>
      </div>
    `;
  }
  /***********************
   * 5) ìŠ¤ì¼€ì¤„ëŸ¬ ë°˜ì˜ ì •ì±…
   ***********************/
  function pickWeakTop2(scores){
    const arr = Object.entries(scores).map(([k,v])=>({k,v}));
    arr.sort((a,b)=>a.v-b.v);
    return arr.slice(0,2);
  }

  function mlstToSchedulePolicy(scores){
    const blockMin = (scores.concentration <= 40) ? 25 : (scores.concentration <= 60 ? 35 : 45);

    let ratio = {
      newLearning: 0.35,
      practice:    0.35,
      review:      0.20,
      meta:        0.10
    };

    if(scores.skill <= 60){
      ratio.review += 0.10;
      ratio.newLearning -= 0.05;
      ratio.practice -= 0.05;
    }

    if(scores.metacognition <= 60){
      ratio.meta += 0.05;
      ratio.practice -= 0.05;
    }

    const needEasyStart = (scores.anxiety <= 40);
    const minDailyMinutes = (scores.will <= 60) ? 60 : 0;
    const deepWorkPerWeek = (scores.motivation >= 80) ? 3 : 1;

    const weakTop2 = pickWeakTop2(scores);
    return { blockMin, ratio, needEasyStart, minDailyMinutes, deepWorkPerWeek, weakTop2 };
  }

  function renderSchedulerPolicy(scores){
    const el = document.getElementById("schedulerPolicy");
    const policy = mlstToSchedulePolicy(scores);

    const pct = (x)=>Math.round(x*100);
    const weakText = policy.weakTop2.map(x=>`${LABELS[x.k]}(${x.v})`).join(", ");

    localStorage.setItem("mlst_schedule_policy_v1", JSON.stringify({
      version: 1,
      createdAt: Date.now(),
      policy
    }));

    el.innerHTML = `
      <div class="mini-card">
        <p style="margin:0;color:#0f172a;">
          <b>ì´ ê²°ê³¼ë¥¼ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ìë™ ë°˜ì˜í•  ìˆ˜ ìˆë„ë¡</b> ì•„ë˜ ì„¤ì •ê°’ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
        </p>

        <div class="policy-grid">
          <div class="kpi">
            <div>
              <b>ê¶Œì¥ ë¸”ë¡ ê¸¸ì´</b>
              <small>ì§‘ì¤‘ë ¥ ì ìˆ˜ ê¸°ë°˜</small>
            </div>
            <div style="font-weight:900;">${policy.blockMin}ë¶„</div>
          </div>

          <div class="kpi">
            <div>
              <b>ë³´ì™„ ìš°ì„ ìˆœìœ„</b>
              <small>ë‚®ì€ 2ê°œ ì˜ì—­</small>
            </div>
            <div style="font-weight:900;">${weakText}</div>
          </div>

          <div class="kpi">
            <div>
              <b>í•™ìŠµ ë¹„ìœ¨(ìë™)</b>
              <small>ì§„ë„/ë¬¸í’€/ë³µìŠµ/ì ê²€</small>
            </div>
            <div style="font-weight:900;">
              ${pct(policy.ratio.newLearning)}/${pct(policy.ratio.practice)}/${pct(policy.ratio.review)}/${pct(policy.ratio.meta)}%
            </div>
          </div>

          <div class="kpi">
            <div>
              <b>íŠ¹ìˆ˜ ì˜µì…˜</b>
              <small>ë¶ˆì•ˆÂ·ì˜ì§€Â·ë™ê¸° ë°˜ì˜</small>
            </div>
            <div style="font-weight:900;">
              ${policy.needEasyStart ? "ì‰¬ìš´ ì‹œì‘ ON" : "ì‰¬ìš´ ì‹œì‘ OFF"} Â·
              ${policy.minDailyMinutes ? `ë°”ë‹¥ë£¨í‹´ ${policy.minDailyMinutes}ë¶„` : "ë°”ë‹¥ë£¨í‹´ ì—†ìŒ"} Â·
              ì‹¬í™” ${policy.deepWorkPerWeek}/ì£¼
            </div>
          </div>
        </div>

        <div style="margin-top:10px;color:var(--muted);font-size:.9rem;">
          * ìŠ¤ì¼€ì¤„ëŸ¬ í˜ì´ì§€ì—ì„œ <code>localStorage.getItem("mlst_profile_v1")</code> ë˜ëŠ”
          <code>localStorage.getItem("mlst_schedule_policy_v1")</code>ë¡œ ë¶ˆëŸ¬ì˜¤ë©´ ë©ë‹ˆë‹¤.
        </div>
      </div>
    `;
  }

  /***********************
   * 6) âœ… NEW: ê³¼ëª©ë³„ GPT í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°
   ***********************/
  function generatePrompt(){
    const subject = document.getElementById("subjectSelect").value;
    const scores = g_lastScores;
    if(!scores){
      alert("ì§„ë‹¨ì„ ë¨¼ì € ì™„ë£Œí•´ ì£¼ì„¸ìš”.");
      return;
    }

    const weak2 = pickWeakTop2(scores).map(x => `${LABELS[x.k]}(${x.v})`).join(", ");
    const strong1 = Object.entries(scores).sort((a,b)=>b[1]-a[1])[0];
    const strongText = `${LABELS[strong1[0]]}(${strong1[1]})`;

    const prompt = `
[${subject} ì „ìš© í•™ìŠµ ì½”ì¹˜ í”„ë¡¬í”„íŠ¸]

ë„ˆëŠ” ${subject} ì„±ì ì„ ì˜¬ë¦¬ëŠ” ì „ë¬¸ í•™ìŠµ ì½”ì¹˜ë‹¤.
ì•„ë˜ MLST ì§„ë‹¨ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì˜¤ëŠ˜ í•™ìŠµì„ "ê°œë…â†’ìœ í˜•â†’ì˜¤ë‹µì›ì¸â†’ì¬ì¸ì¶œ" ë£¨í‹´ìœ¼ë¡œ ì„¤ê³„í•´ë¼.

- í•™ìŠµë™ê¸°: ${scores.motivation}
- ì‹¬ë¦¬ì•ˆì •: ${scores.anxiety}
- ì§‘ì¤‘ë ¥: ${scores.concentration}
- ê³µë¶€ê¸°ìˆ : ${scores.skill}
- í•™ìŠµì˜ì§€: ${scores.will}
- ë©”íƒ€ì¸ì§€: ${scores.metacognition}

- ê°•ì (Top): ${strongText}
- ë³´ì™„(Top2): ${weak2}

ì¶œë ¥ ê·œì¹™(ë§¤ìš° ì¤‘ìš”):
1) ì˜¤ëŠ˜ í•´ì•¼ í•  "í•™ìŠµ ì„¸íŠ¸"ë¥¼ 3ê°œë¡œ ìª¼ê°œë¼(ê° 20~40ë¶„).
2) ê° ì„¸íŠ¸ ì‹œì‘ì€ ë°˜ë“œì‹œ "í•µì‹¬ ì•„ì´ë””ì–´ 1ì¤„"ì„ ì“°ê²Œ í•˜ë¼.
3) ì˜¤ë‹µì€ ì›ì¸ 1ê°œë§Œ ì§€ì •í•˜ê³ (ê°œë…/ê³„ì‚°/ì¡°ê±´ëˆ„ë½/ì‹œê°„/ë…í•´ ë“±), ê·¸ ì›ì¸ì„ ë§‰ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ 1ê°œë¥¼ ì œì‹œí•˜ë¼.
4) ë³´ì™„ Top2(${weak2})ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì‹œê°„ ë°°ë¶„ì„ ì¡°ì •í•˜ë¼.
5) ë§ˆì§€ë§‰ì— ì¬ì¸ì¶œ ë³µìŠµ íƒ€ì´ë°ì„ 1ì¼Â·2ì¼Â·6ì¼Â·31ì¼ ê¸°ì¤€ìœ¼ë¡œ ì œì‹œí•˜ë¼.
`.trim();

    document.getElementById("promptBox").value = prompt;
  }

  function copyPrompt(){
    const box = document.getElementById("promptBox");
    if(!box.value){
      alert("ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.");
      return;
    }
    box.select();
    box.setSelectionRange(0, 999999);
    document.execCommand("copy");
    alert("í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  /***********************
   * 7) ì´ë¯¸ì§€ ì €ì¥
   ***********************/
  function downloadResult(){
    html2canvas(document.getElementById('captureArea')).then(canvas => {
      const link = document.createElement('a');
      link.download = 'MLST_ì§„ë‹¨ê²°ê³¼.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  }
</script>
</body>
</html>
